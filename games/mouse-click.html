<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–õ–æ–ø–Ω–∏ –∫—É–ª—å–∫—É | –Ü–≥—Ä–∏-—Ç—Ä–µ–Ω–∞–∂–µ—Ä–∏</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23667eea'/%3E%3Cstop offset='100%25' stop-color='%23f093fb'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Ctext x='50' y='72' font-family='Arial,sans-serif' font-size='60' font-weight='bold' fill='white' text-anchor='middle'%3EI%3C/text%3E%3C/svg%3E">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles.css">
  <style>
    /* ===== GAME CONTAINER ===== */
    body {
      padding: 0;
      min-height: 100vh;
      overflow: hidden;
    }

    .game-container {
      position: relative;
      z-index: 1;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== SCREENS ===== */
    .screen {
      display: none;
      width: 100%;
      height: 100%;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .screen.active {
      display: flex;
    }

    /* ===== MENU SCREEN ===== */
    #menu-screen .menu-content {
      text-align: center;
      max-width: 400px;
      width: 100%;
    }

    #menu-screen h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    #menu-screen .game-emoji {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }

    .menu-subtitle {
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 30px;
      font-size: 1.1rem;
    }

    .difficulty-section h2 {
      color: rgba(255, 255, 255, 0.9);
      font-size: 1.2rem;
      margin-bottom: 16px;
    }

    .difficulty-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 30px;
    }

    .difficulty-btn {
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-family: 'Inter', sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .difficulty-btn[data-level="easy"] {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      color: #1a1a3e;
    }

    .difficulty-btn[data-level="medium"] {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      color: #1a1a3e;
    }

    .difficulty-btn[data-level="hard"] {
      background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
      color: white;
    }

    .difficulty-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .difficulty-btn .record {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .records-section {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }

    .records-section h3 {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9rem;
      margin-bottom: 12px;
    }

    .records-list {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 10px;
    }

    .record-item {
      text-align: center;
    }

    .record-item .level {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .record-item .score {
      font-size: 1.3rem;
      font-weight: 700;
      color: #fee140;
    }

    .menu-back-btn {
      display: inline-block;
      padding: 14px 32px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .menu-back-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    /* ===== GAME SCREEN ===== */
    #game-screen {
      padding: 0;
      width: 100%;
    }

    #game-screen.active {
      display: flex;
      flex-direction: column;
    }

    .game-hud {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 10;
    }

    .hud-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      font-weight: 600;
    }

    .hud-item .label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.85rem;
      font-weight: 400;
    }

    .hud-item .value {
      font-size: 1.3rem;
      min-width: 40px;
    }

    .hud-score .value { color: #fee140; }
    .hud-time .value { color: #4facfe; }

    .hud-lives {
      display: flex;
      gap: 4px;
    }

    .heart {
      font-size: 1.4rem;
      transition: all 0.3s ease;
    }

    .heart.lost {
      opacity: 0.2;
      transform: scale(0.8);
    }

    .pause-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .pause-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    #game-area {
      flex: 1;
      width: 100%;
      position: relative;
      overflow: hidden;
      cursor: crosshair;
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 50%, #0f2847 100%);
      z-index: 5;
    }

    /* ===== BALLOONS ===== */
    .balloon {
      position: absolute;
      border-radius: 50% 50% 50% 50% / 55% 55% 45% 45%;
      cursor: pointer;
      transition: transform 0.1s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      user-select: none;
      z-index: 10;
      opacity: 1 !important;
    }

    .balloon::before {
      content: '';
      position: absolute;
      top: 10%;
      left: 20%;
      width: 20%;
      height: 20%;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 50%;
    }

    .balloon::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 10px solid currentColor;
    }

    .balloon.normal {
      background: linear-gradient(135deg, var(--balloon-color-1, #667eea), var(--balloon-color-2, #764ba2));
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), inset 0 -10px 20px rgba(0, 0, 0, 0.15);
    }

    .balloon.golden {
      background: linear-gradient(135deg, #ffd700, #ffec8b, #ffd700);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), 0 4px 15px rgba(0, 0, 0, 0.2);
      animation: glow 1s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), 0 4px 15px rgba(0, 0, 0, 0.2); }
      to { box-shadow: 0 0 35px rgba(255, 215, 0, 0.9), 0 4px 15px rgba(0, 0, 0, 0.2); }
    }

    .balloon.bomb {
      background: linear-gradient(135deg, #2d2d2d, #4a4a4a, #2d2d2d);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
    }

    .balloon.time-bonus {
      background: linear-gradient(135deg, #43e97b, #38f9d7);
      box-shadow: 0 0 15px rgba(67, 233, 123, 0.5), 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .balloon:hover {
      transform: scale(1.05);
    }

    .balloon.popping {
      animation: pop 0.3s ease-out forwards;
      pointer-events: none;
    }

    @keyframes pop {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.7; }
      100% { transform: scale(0); opacity: 0; }
    }

    .score-popup {
      position: absolute;
      font-weight: 700;
      font-size: 1.5rem;
      pointer-events: none;
      animation: scoreFloat 1s ease-out forwards;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .score-popup.positive { color: #43e97b; }
    .score-popup.negative { color: #f5576c; }
    .score-popup.golden { color: #ffd700; }
    .score-popup.time { color: #4facfe; }

    @keyframes scoreFloat {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
    }

    /* ===== PAUSE OVERLAY ===== */
    #pause-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    #pause-overlay.active {
      display: flex;
    }

    #pause-overlay h2 {
      font-size: 2.5rem;
      color: white;
      margin-bottom: 30px;
    }

    .pause-buttons {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .pause-action-btn {
      padding: 16px 48px;
      border: none;
      border-radius: 12px;
      font-family: 'Inter', sans-serif;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .pause-action-btn.resume {
      background: linear-gradient(135deg, #43e97b, #38f9d7);
      color: #1a1a3e;
    }

    .pause-action-btn.quit {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
    }

    .pause-action-btn:hover {
      transform: translateY(-3px);
    }

    /* ===== RESULT SCREEN ===== */
    #result-screen .result-content {
      text-align: center;
      max-width: 400px;
    }

    #result-screen h2 {
      font-size: 2rem;
      color: white;
      margin-bottom: 10px;
    }

    .result-emoji {
      font-size: 5rem;
      margin-bottom: 20px;
    }

    .final-score {
      font-size: 4rem;
      font-weight: 700;
      color: #fee140;
      margin-bottom: 10px;
    }

    .final-score-label {
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 20px;
    }

    .new-record {
      background: linear-gradient(135deg, #ffd700, #ffec8b);
      color: #1a1a3e;
      padding: 10px 24px;
      border-radius: 20px;
      font-weight: 700;
      display: inline-block;
      margin-bottom: 20px;
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .result-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 30px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-item .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }

    .stat-item .stat-label {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .result-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .result-btn {
      padding: 16px 32px;
      border: none;
      border-radius: 12px;
      font-family: 'Inter', sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: block;
    }

    .result-btn.play-again {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .result-btn.back-to-menu {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
    }

    .result-btn:hover {
      transform: translateY(-3px);
    }

    /* ===== MOBILE ADAPTATIONS ===== */
    @media (max-width: 500px) {
      #menu-screen h1 { font-size: 2rem; }
      #menu-screen .game-emoji { font-size: 3rem; }

      .game-hud {
        padding: 10px 12px;
        flex-wrap: wrap;
        gap: 8px;
      }

      .hud-item .value { font-size: 1.1rem; }
      .heart { font-size: 1.2rem; }

      .final-score { font-size: 3rem; }

      .result-stats {
        flex-direction: column;
        gap: 15px;
      }
    }

    /* ===== REDUCED MOTION ===== */
    @media (prefers-reduced-motion: reduce) {
      .balloon, .score-popup {
        animation-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="matrix">
    <span>10110101</span>
    <span>01101001</span>
    <span>11010110</span>
    <span>00101101</span>
    <span>10011010</span>
    <span>01110100</span>
    <span>11001011</span>
    <span>00110110</span>
    <span>10101001</span>
    <span>01011010</span>
  </div>

  <div class="shapes">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
    <div class="shape shape-4"></div>
    <div class="shape shape-5"></div>
    <div class="shape shape-6"></div>
  </div>

  <div class="game-container">
    <!-- Menu Screen -->
    <div id="menu-screen" class="screen active">
      <div class="menu-content">
        <div class="game-emoji">üéà</div>
        <h1>–õ–æ–ø–Ω–∏ –∫—É–ª—å–∫—É</h1>
        <p class="menu-subtitle">–¢—Ä–µ–Ω—É–π —à–≤–∏–¥–∫—ñ—Å—Ç—å —Ç–∞ —Ç–æ—á–Ω—ñ—Å—Ç—å –∫–ª—ñ–∫—ñ–≤</p>

        <div class="difficulty-section">
          <h2>–û–±–µ—Ä–∏ —Ä—ñ–≤–µ–Ω—å —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ</h2>
          <div class="difficulty-buttons">
            <button class="difficulty-btn" data-level="easy">
              <span>–õ–µ–≥–∫–∏–π</span>
              <span class="record" id="record-easy">–†–µ–∫–æ—Ä–¥: 0</span>
            </button>
            <button class="difficulty-btn" data-level="medium">
              <span>–°–µ—Ä–µ–¥–Ω—ñ–π</span>
              <span class="record" id="record-medium">–†–µ–∫–æ—Ä–¥: 0</span>
            </button>
            <button class="difficulty-btn" data-level="hard">
              <span>–í–∞–∂–∫–∏–π</span>
              <span class="record" id="record-hard">–†–µ–∫–æ—Ä–¥: 0</span>
            </button>
          </div>
        </div>

        <div class="records-section">
          <h3>–¢–∏–ø–∏ –∫—É–ª—å–æ–∫</h3>
          <div class="records-list">
            <div class="record-item">
              <div class="score">üéà</div>
              <div class="level">+1 –æ—á–∫–æ</div>
            </div>
            <div class="record-item">
              <div class="score">‚ú®</div>
              <div class="level">+5 –æ—á–æ–∫</div>
            </div>
            <div class="record-item">
              <div class="score">üí£</div>
              <div class="level">-1 –∂–∏—Ç—Ç—è</div>
            </div>
            <div class="record-item">
              <div class="score">‚è±Ô∏è</div>
              <div class="level">+5 —Å–µ–∫</div>
            </div>
          </div>
        </div>

        <a href="../games.html" class="menu-back-btn">‚Üê –ù–∞–∑–∞–¥ –¥–æ —ñ–≥–æ—Ä</a>
      </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen">
      <div class="game-hud">
        <div class="hud-item hud-score">
          <span class="label">–û—á–∫–∏</span>
          <span class="value" id="score">0</span>
        </div>
        <div class="hud-item hud-time">
          <span class="label">–ß–∞—Å</span>
          <span class="value" id="time">60</span>
        </div>
        <div class="hud-item">
          <span class="label">–ñ–∏—Ç—Ç—è</span>
          <div class="hud-lives" id="lives">
            <span class="heart">‚ù§Ô∏è</span>
            <span class="heart">‚ù§Ô∏è</span>
            <span class="heart">‚ù§Ô∏è</span>
          </div>
        </div>
        <button class="pause-btn" id="pause-btn">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
      </div>
      <div id="game-area"></div>
    </div>

    <!-- Pause Overlay -->
    <div id="pause-overlay">
      <h2>‚è∏Ô∏è –ü–∞—É–∑–∞</h2>
      <div class="pause-buttons">
        <button class="pause-action-btn resume" id="resume-btn">‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
        <button class="pause-action-btn quit" id="quit-btn">üö™ –í–∏–π—Ç–∏ –≤ –º–µ–Ω—é</button>
      </div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="screen">
      <div class="result-content">
        <div class="result-emoji" id="result-emoji">üéâ</div>
        <h2 id="result-title">–ì—Ä—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</h2>
        <div class="final-score" id="final-score">0</div>
        <div class="final-score-label">–æ—á–æ–∫</div>
        <div class="new-record" id="new-record" style="display: none;">üèÜ –ù–æ–≤–∏–π —Ä–µ–∫–æ—Ä–¥!</div>

        <div class="result-stats">
          <div class="stat-item">
            <div class="stat-value" id="stat-popped">0</div>
            <div class="stat-label">–∫—É–ª—å–æ–∫ –ª–æ–ø–Ω—É—Ç–æ</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="stat-accuracy">0%</div>
            <div class="stat-label">—Ç–æ—á–Ω—ñ—Å—Ç—å</div>
          </div>
        </div>

        <div class="result-buttons">
          <button class="result-btn play-again" id="play-again-btn">üîÑ –ì—Ä–∞—Ç–∏ —â–µ</button>
          <button class="result-btn back-to-menu" id="back-menu-btn">üìã –î–æ –º–µ–Ω—é</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== GAME CONFIGURATION =====
    const DIFFICULTY = {
      easy: {
        name: '–õ–µ–≥–∫–∏–π',
        sizeMin: 70,
        sizeMax: 90,
        speedMin: 80,
        speedMax: 150,
        spawnInterval: 1500,
        bombChance: 0
      },
      medium: {
        name: '–°–µ—Ä–µ–¥–Ω—ñ–π',
        sizeMin: 50,
        sizeMax: 70,
        speedMin: 120,
        speedMax: 200,
        spawnInterval: 1000,
        bombChance: 0.1
      },
      hard: {
        name: '–í–∞–∂–∫–∏–π',
        sizeMin: 35,
        sizeMax: 55,
        speedMin: 180,
        speedMax: 280,
        spawnInterval: 700,
        bombChance: 0.2
      }
    };

    const BALLOON_COLORS = [
      ['#667eea', '#764ba2'],
      ['#f093fb', '#f5576c'],
      ['#4facfe', '#00f2fe'],
      ['#43e97b', '#38f9d7'],
      ['#fa709a', '#fee140'],
      ['#a8edea', '#fed6e3'],
      ['#ff9a9e', '#fecfef'],
      ['#ffecd2', '#fcb69f']
    ];

    const GAME_DURATION = 60;
    const INITIAL_LIVES = 3;
    const GOLDEN_CHANCE = 0.08;
    const TIME_BONUS_CHANCE = 0.05;

    // ===== GAME STATE =====
    let gameState = {
      isRunning: false,
      isPaused: false,
      difficulty: 'easy',
      score: 0,
      lives: INITIAL_LIVES,
      timeLeft: GAME_DURATION,
      balloons: [],
      balloonsPopped: 0,
      totalClicks: 0,
      spawnTimer: null,
      gameTimer: null,
      lastTimestamp: 0,
      animationFrameId: null
    };

    // ===== DOM ELEMENTS =====
    const screens = {
      menu: document.getElementById('menu-screen'),
      game: document.getElementById('game-screen'),
      result: document.getElementById('result-screen')
    };

    const elements = {
      gameArea: document.getElementById('game-area'),
      score: document.getElementById('score'),
      time: document.getElementById('time'),
      lives: document.getElementById('lives'),
      pauseBtn: document.getElementById('pause-btn'),
      pauseOverlay: document.getElementById('pause-overlay'),
      resumeBtn: document.getElementById('resume-btn'),
      quitBtn: document.getElementById('quit-btn'),
      finalScore: document.getElementById('final-score'),
      newRecord: document.getElementById('new-record'),
      resultEmoji: document.getElementById('result-emoji'),
      resultTitle: document.getElementById('result-title'),
      statPopped: document.getElementById('stat-popped'),
      statAccuracy: document.getElementById('stat-accuracy'),
      playAgainBtn: document.getElementById('play-again-btn'),
      backMenuBtn: document.getElementById('back-menu-btn')
    };

    // ===== BALLOON CLASS =====
    class Balloon {
      constructor(config) {
        this.id = Math.random().toString(36).substr(2, 9);
        this.x = config.x;
        this.y = config.y;
        this.size = config.size;
        this.speed = config.speed;
        this.type = config.type;
        this.direction = config.direction;
        this.element = null;
        this.isPopped = false;

        this.createElement();
      }

      createElement() {
        this.element = document.createElement('div');
        this.element.className = `balloon ${this.type}`;
        this.element.style.width = `${this.size}px`;
        this.element.style.height = `${this.size * 1.15}px`;
        this.element.style.left = `${this.x}px`;
        this.element.style.top = `${this.y}px`;

        if (this.type === 'normal') {
          const colors = BALLOON_COLORS[Math.floor(Math.random() * BALLOON_COLORS.length)];
          this.element.style.setProperty('--balloon-color-1', colors[0]);
          this.element.style.setProperty('--balloon-color-2', colors[1]);
          this.element.style.color = colors[1];
        } else if (this.type === 'bomb') {
          this.element.textContent = 'üí£';
          this.element.style.color = '#2d2d2d';
        } else if (this.type === 'time-bonus') {
          this.element.textContent = '‚è±Ô∏è';
          this.element.style.color = '#38f9d7';
        } else if (this.type === 'golden') {
          this.element.textContent = '‚ú®';
          this.element.style.color = '#ffd700';
        }

        this.element.addEventListener('click', (e) => this.onClick(e));
        elements.gameArea.appendChild(this.element);
      }

      update(dt) {
        if (this.isPopped) return;

        const dx = Math.cos(this.direction) * this.speed * dt;
        const dy = Math.sin(this.direction) * this.speed * dt;

        this.x += dx;
        this.y += dy;

        const areaRect = elements.gameArea.getBoundingClientRect();
        const maxX = areaRect.width - this.size;
        const maxY = areaRect.height - this.size * 1.15;

        // Bounce off walls
        if (this.x <= 0 || this.x >= maxX) {
          this.direction = Math.PI - this.direction;
          this.x = Math.max(0, Math.min(maxX, this.x));
        }
        if (this.y <= 0 || this.y >= maxY) {
          this.direction = -this.direction;
          this.y = Math.max(0, Math.min(maxY, this.y));
        }
      }

      render() {
        if (this.element && !this.isPopped) {
          this.element.style.left = `${this.x}px`;
          this.element.style.top = `${this.y}px`;
        }
      }

      onClick(e) {
        if (this.isPopped || gameState.isPaused) return;
        e.stopPropagation();
        this.pop();
      }

      pop() {
        if (this.isPopped) return;
        this.isPopped = true;
        this.element.classList.add('popping');

        let points = 0;
        let popupClass = 'positive';
        let popupText = '';

        switch (this.type) {
          case 'normal':
            points = 1;
            popupText = '+1';
            gameState.balloonsPopped++;
            break;
          case 'golden':
            points = 5;
            popupText = '+5';
            popupClass = 'golden';
            gameState.balloonsPopped++;
            break;
          case 'bomb':
            loseLife();
            popupText = 'üí•';
            popupClass = 'negative';
            break;
          case 'time-bonus':
            points = 2;
            gameState.timeLeft += 5;
            popupText = '+5s';
            popupClass = 'time';
            gameState.balloonsPopped++;
            break;
        }

        if (points !== 0) {
          gameState.score += points;
          updateHUD();
        }

        showScorePopup(this.x + this.size / 2, this.y, popupText, popupClass);

        setTimeout(() => this.remove(), 300);
      }

      remove() {
        if (this.element && this.element.parentNode) {
          this.element.parentNode.removeChild(this.element);
        }
        const index = gameState.balloons.indexOf(this);
        if (index > -1) {
          gameState.balloons.splice(index, 1);
        }
      }
    }

    // ===== GAME FUNCTIONS =====
    function showScreen(screenName) {
      Object.values(screens).forEach(screen => screen.classList.remove('active'));
      screens[screenName].classList.add('active');
    }

    function loadRecords() {
      const records = JSON.parse(localStorage.getItem('balloonGameRecords') || '{}');
      document.getElementById('record-easy').textContent = `–†–µ–∫–æ—Ä–¥: ${records.easy?.highScore || 0}`;
      document.getElementById('record-medium').textContent = `–†–µ–∫–æ—Ä–¥: ${records.medium?.highScore || 0}`;
      document.getElementById('record-hard').textContent = `–†–µ–∫–æ—Ä–¥: ${records.hard?.highScore || 0}`;
    }

    function saveRecord(difficulty, score) {
      const records = JSON.parse(localStorage.getItem('balloonGameRecords') || '{}');
      const currentRecord = records[difficulty]?.highScore || 0;

      if (score > currentRecord) {
        records[difficulty] = {
          highScore: score,
          lastPlayed: new Date().toISOString().split('T')[0]
        };
        localStorage.setItem('balloonGameRecords', JSON.stringify(records));
        return true;
      }
      return false;
    }

    function startGame(difficulty) {
      gameState = {
        isRunning: true,
        isPaused: false,
        difficulty: difficulty,
        score: 0,
        lives: INITIAL_LIVES,
        timeLeft: GAME_DURATION,
        balloons: [],
        balloonsPopped: 0,
        totalClicks: 0,
        spawnTimer: null,
        gameTimer: null,
        lastTimestamp: 0,
        animationFrameId: null
      };

      elements.gameArea.innerHTML = '';
      updateHUD();
      updateLivesDisplay();
      showScreen('game');

      // Track clicks for accuracy
      elements.gameArea.addEventListener('click', onGameAreaClick);

      // Wait for the screen to render before spawning balloons
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          // Start spawning balloons
          spawnBalloon();
          gameState.spawnTimer = setInterval(spawnBalloon, DIFFICULTY[difficulty].spawnInterval);
        });
      });

      // Start game timer
      gameState.gameTimer = setInterval(() => {
        if (!gameState.isPaused) {
          gameState.timeLeft--;
          updateHUD();
          if (gameState.timeLeft <= 0) {
            endGame();
          }
        }
      }, 1000);

      // Start game loop
      gameState.lastTimestamp = performance.now();
      gameState.animationFrameId = requestAnimationFrame(gameLoop);
    }

    function gameLoop(timestamp) {
      if (!gameState.isRunning) return;

      if (!gameState.isPaused) {
        const dt = (timestamp - gameState.lastTimestamp) / 1000;
        gameState.lastTimestamp = timestamp;

        gameState.balloons.forEach(balloon => {
          balloon.update(dt);
          balloon.render();
        });
      } else {
        gameState.lastTimestamp = timestamp;
      }

      gameState.animationFrameId = requestAnimationFrame(gameLoop);
    }

    function spawnBalloon() {
      if (gameState.isPaused || !gameState.isRunning) return;

      const config = DIFFICULTY[gameState.difficulty];
      const areaRect = elements.gameArea.getBoundingClientRect();

      // Don't spawn if game area has no size yet
      if (areaRect.width < 100 || areaRect.height < 100) return;

      const size = Math.random() * (config.sizeMax - config.sizeMin) + config.sizeMin;
      const speed = Math.random() * (config.speedMax - config.speedMin) + config.speedMin;

      let type = 'normal';
      const rand = Math.random();
      if (rand < config.bombChance) {
        type = 'bomb';
      } else if (rand < config.bombChance + GOLDEN_CHANCE) {
        type = 'golden';
      } else if (rand < config.bombChance + GOLDEN_CHANCE + TIME_BONUS_CHANCE) {
        type = 'time-bonus';
      }

      const balloon = new Balloon({
        x: Math.random() * (areaRect.width - size),
        y: Math.random() * (areaRect.height - size * 1.15),
        size: size,
        speed: speed,
        type: type,
        direction: Math.random() * Math.PI * 2
      });

      gameState.balloons.push(balloon);

      // Remove old balloons if too many
      if (gameState.balloons.length > 15) {
        const oldest = gameState.balloons[0];
        if (!oldest.isPopped) {
          oldest.remove();
        }
      }
    }

    function onGameAreaClick() {
      gameState.totalClicks++;
    }

    function showScorePopup(x, y, text, className) {
      const popup = document.createElement('div');
      popup.className = `score-popup ${className}`;
      popup.textContent = text;
      popup.style.left = `${x}px`;
      popup.style.top = `${y}px`;
      elements.gameArea.appendChild(popup);

      setTimeout(() => {
        if (popup.parentNode) {
          popup.parentNode.removeChild(popup);
        }
      }, 1000);
    }

    function updateHUD() {
      elements.score.textContent = gameState.score;
      elements.time.textContent = gameState.timeLeft;
    }

    function updateLivesDisplay() {
      const hearts = elements.lives.querySelectorAll('.heart');
      hearts.forEach((heart, index) => {
        if (index >= gameState.lives) {
          heart.classList.add('lost');
        } else {
          heart.classList.remove('lost');
        }
      });
    }

    function loseLife() {
      gameState.lives--;
      updateLivesDisplay();

      if (gameState.lives <= 0) {
        endGame();
      }
    }

    function pauseGame() {
      gameState.isPaused = true;
      elements.pauseOverlay.classList.add('active');
    }

    function resumeGame() {
      gameState.isPaused = false;
      gameState.lastTimestamp = performance.now();
      elements.pauseOverlay.classList.remove('active');
    }

    function endGame() {
      gameState.isRunning = false;

      clearInterval(gameState.spawnTimer);
      clearInterval(gameState.gameTimer);
      cancelAnimationFrame(gameState.animationFrameId);

      elements.gameArea.removeEventListener('click', onGameAreaClick);
      elements.pauseOverlay.classList.remove('active');

      // Calculate stats
      const accuracy = gameState.totalClicks > 0
        ? Math.round((gameState.balloonsPopped / gameState.totalClicks) * 100)
        : 0;

      // Check for new record
      const isNewRecord = saveRecord(gameState.difficulty, gameState.score);

      // Update result screen
      elements.finalScore.textContent = gameState.score;
      elements.statPopped.textContent = gameState.balloonsPopped;
      elements.statAccuracy.textContent = `${accuracy}%`;

      if (isNewRecord) {
        elements.newRecord.style.display = 'inline-block';
        elements.resultEmoji.textContent = 'üèÜ';
        elements.resultTitle.textContent = '–ù–æ–≤–∏–π —Ä–µ–∫–æ—Ä–¥!';
      } else {
        elements.newRecord.style.display = 'none';
        if (gameState.lives <= 0) {
          elements.resultEmoji.textContent = 'üí•';
          elements.resultTitle.textContent = '–ì—Ä—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ!';
        } else {
          elements.resultEmoji.textContent = 'üéâ';
          elements.resultTitle.textContent = '–ß–∞—Å –≤–∏–π—à–æ–≤!';
        }
      }

      showScreen('result');
      loadRecords();
    }

    function quitToMenu() {
      gameState.isRunning = false;

      clearInterval(gameState.spawnTimer);
      clearInterval(gameState.gameTimer);
      cancelAnimationFrame(gameState.animationFrameId);

      elements.gameArea.removeEventListener('click', onGameAreaClick);
      elements.pauseOverlay.classList.remove('active');

      showScreen('menu');
    }

    // ===== EVENT LISTENERS =====
    document.querySelectorAll('.difficulty-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        startGame(btn.dataset.level);
      });
    });

    elements.pauseBtn.addEventListener('click', pauseGame);
    elements.resumeBtn.addEventListener('click', resumeGame);
    elements.quitBtn.addEventListener('click', quitToMenu);
    elements.playAgainBtn.addEventListener('click', () => startGame(gameState.difficulty));
    elements.backMenuBtn.addEventListener('click', () => showScreen('menu'));

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && gameState.isRunning) {
        if (gameState.isPaused) {
          resumeGame();
        } else {
          pauseGame();
        }
      }
    });

    // ===== INITIALIZATION =====
    loadRecords();
  </script>
</body>
</html>
